@page "/inventories"

@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<h3>Inventories</h3>

<div class="d-flex mb-3">
    <input class="form-control me-2" placeholder="Search..." @bind="searchTerm" />
    <button class="btn btn-primary" @onclick="OpenCreate">Create Inventory</button>

    <div class="ms-auto">
        <span class="me-2">Tags:</span>
        @foreach (var t in allTags)
        {
            <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => FilterByTag(t.Name)">
                @t.Name
            </button>
        }
    </div>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Title</th>
            <th>Category</th>
            <th>Public</th>
            <th>Items</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var inv in inventories)
        {
            <tr>
                <td><a href="@($"/inventory/{inv.Id}")">@inv.Title</a></td>
                <td>@inv.Category?.Name</td>
                <td>@(inv.IsPublic ? "Yes" : "No")</td>
                <td>@(itemCounts.ContainsKey(inv.Id) ? itemCounts[inv.Id] : 0)</td>
            </tr>
        }
    </tbody>
</table>

@code {
    private List<Inventory> inventories = new();
    private List<Tag> allTags = new();
    private Dictionary<int, int> itemCounts = new();
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        allTags = await Db.Tags.OrderBy(t => t.Name).ToListAsync();
        inventories = await Db.Inventories.Include(i => i.Category).ToListAsync();

        // âœ… Efficient: fetch counts in one go
        var counts = await Db.Items
            .GroupBy(i => i.InventoryId)
            .Select(g => new { g.Key, Count = g.Count() })
            .ToListAsync();

        itemCounts = counts.ToDictionary(x => x.Key, x => x.Count);
    }

    void OpenCreate() => Nav.NavigateTo("/inventory/create");

    void FilterByTag(string tag) => Nav.NavigateTo($"/search?tag={Uri.EscapeDataString(tag)}");
}
